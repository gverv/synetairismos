{% extends "main.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-5">
    <h2>Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î Î¿Ï„Î¯ÏƒÎ¼Î±Ï„Î¿Ï‚</h2>
    <form method="post">
        {% csrf_token %}
        {{ form|crispy }}
        <button type="submit" class="btn btn-success">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
        <button type="button" class="btn btn-info" id="copyMsgClb">Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® ÎœÎ·Î½ÏÎ¼Î±Ï„Î¿Ï‚</button>
    </form>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        let counterSelect = document.getElementById("id_counter");
        let initialIndication = document.getElementById("id_initialIndication");
        let finalIndication = document.getElementById("id_finalIndication");
        let cubicMeters = document.getElementById("id_cubicMeters");
        let billableCubicMeters = document.getElementById("id_billableCubicMeters");
        let hydronomistsCubicMeters = document.getElementById("id_hydronomistsCubicMeters");
        let cost = document.getElementById("id_cost");
        let hydronomistsRight = document.getElementById("id_hydronomistsRight");
        let costPerMeter = document.getElementById("id_costPerMeter");
        let customer = document.getElementById("id_customer");
        let date = document.getElementById("id_date");
        let viberMsg = document.getElementById("id_viberMsg");
    
        // ğŸ”¹ Î‘Î½Î¬ÎºÏ„Î·ÏƒÎ· Ï„Î·Ï‚ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î±Ï‚ Ï„Î¹Î¼Î®Ï‚ `finalIndication` Î³Î¹Î± Ï„Î¿Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ Î¼ÎµÏ„ÏÎ·Ï„Î®
        function fetchFinalIndication() {
            let counterId = counterSelect.value;
            if (counterId) {
                fetch(`/get-final-indication/${counterId}/`)
                    .then(response => response.json())
                    .then(data => {
                        initialIndication.value = data.finalIndication !== null ? data.finalIndication : "";
                        updateValues();  // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î­Î½Ï‰Î½ Ï„Î¹Î¼ÏÎ½
                        updateViberMsg(); // Î‘Î½Î±Î½ÎµÏÎ½ÎµÎ¹ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î± Viber
                    })
                    .catch(error => console.error("Î£Ï†Î¬Î»Î¼Î±:", error));
            }
        }
    
        // ğŸ”¹ Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï„Ï‰Î½ Ï„Î¹Î¼ÏÎ½ Î¼Îµ Î²Î¬ÏƒÎ· Ï„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® & Ï„ÎµÎ»Î¹ÎºÎ® Î­Î½Î´ÎµÎ¹Î¾Î·
        function updateValues() {
            let finalValue = parseFloat(finalIndication.value) || 0;
            let initialValue = parseFloat(initialIndication.value) || 0;
            let difference = finalValue - initialValue;
    
            cubicMeters.value = difference;
            billableCubicMeters.value = difference;
            hydronomistsCubicMeters.value = difference;
            cost.value = (difference * parseFloat(costPerMeter.value)).toFixed(2);
            hydronomistsRight.value = (difference * 0.05).toFixed(2);
    
            updateViberMsg();  // Î‘Î½Î±Î½ÎµÏÎ½ÎµÎ¹ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î± Viber
        }
    
        // ğŸ”¹ Î”Ï…Î½Î±Î¼Î¹ÎºÎ® ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï… `viberMsg`
        function updateViberMsg() {
            let customerValue = customer.options[customer.selectedIndex]?.text || "";
            // {% comment %} let dateValue = date.value || ""; {% endcomment %}
            // ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚: Î±Ï€ÏŒ "2025-06-27" ÏƒÎµ "27-06-2025"
            let dateRaw = date.value || "";
            let dateValue = "";
            if (dateRaw) {
                const [yyyy, mm, dd] = dateRaw.split("-");
                dateValue = `${dd}-${mm}-${yyyy}`;
            }
            let finalValue = finalIndication.value || "";
            let initialValue = initialIndication.value || "";
            let costValue = cost.value || "";
            let billableCubicMetersValue = billableCubicMeters.value || "";
    
            let message = `${customerValue}, ${dateValue}, ${finalValue} - ${initialValue} = ${billableCubicMetersValue} ÎºÏ…Î²Î¹ÎºÎ¬, ${costValue}â‚¬`;
            viberMsg.value = message;
        }
    
        // ğŸ”¹ Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· event listeners
        counterSelect.addEventListener("change", fetchFinalIndication);
        finalIndication.addEventListener("input", updateValues);
        initialIndication.addEventListener("input", updateValues);
        costPerMeter.addEventListener("input", updateValues);
        customer.addEventListener("change", updateViberMsg);
        date.addEventListener("input", updateViberMsg);
        cost.addEventListener("input", updateViberMsg);
    });

    document.addEventListener("DOMContentLoaded", function() {
        let copyButton = document.getElementById("copyMsgClb");
        let viberMsg = document.getElementById("id_viberMsg");

        copyButton.addEventListener("click", function() {
            if (viberMsg.value) {
                navigator.clipboard.writeText(viberMsg.value).then(() => {
//                    alert("Î¤Î¿ Î¼Î®Î½Ï…Î¼Î± Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ ÏƒÏ„Î¿ Ï€ÏÏŒÏ‡ÎµÎ¹ÏÎ¿!");
                }).catch(err => {
                    console.error("Î£Ï†Î¬Î»Î¼Î± Î±Î½Ï„Î¹Î³ÏÎ±Ï†Î®Ï‚:", err);
                });
            } else {
                alert("Î¤Î¿ Ï€ÎµÎ´Î¯Î¿ Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚ ÎµÎ¯Î½Î±Î¹ ÎºÎµÎ½ÏŒ!");
            }
        });
    });
</script>
            
{% endblock %}
