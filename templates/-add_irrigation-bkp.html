{% extends "main.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-5">
    <h2>Προσθήκη Ποτίσματος</h2>
    <form method="post">
        {% csrf_token %}
        {{ form|crispy }}
        <button type="submit" class="btn btn-success">Αποθήκευση</button>
        <button type="button" class="btn btn-info" id="copyMsgClb">Αντιγραφή Μηνύματος</button>
    </form>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        let counterSelect = document.getElementById("id_counter");
        let initialIndication = document.getElementById("id_initialIndication");
        let finalIndication = document.getElementById("id_finalIndication");
        let cubicMeters = document.getElementById("id_cubicMeters");
        let billableCubicMeters = document.getElementById("id_billableCubicMeters");
        let hydronomistsCubicMeters = document.getElementById("id_hydronomistsCubicMeters");
        let cost = document.getElementById("id_cost");
        let hydronomistsRight = document.getElementById("id_hydronomistsRight");
        let costPerMeter = document.getElementById("id_costPerMeter");
        let customer = document.getElementById("id_customer");
        let date = document.getElementById("id_date");
        let viberMsg = document.getElementById("id_viberMsg");
    
        // 🔹 Ανάκτηση της τελευταίας τιμής `finalIndication` για τον επιλεγμένο μετρητή
        function fetchFinalIndication() {
            let counterId = counterSelect.value;
            if (counterId) {
                fetch(`/get-final-indication/${counterId}/`)
                    .then(response => response.json())
                    .then(data => {
                        initialIndication.value = data.finalIndication !== null ? data.finalIndication : "";
                        updateValues();  // Ενημέρωση υπολογισμένων τιμών
                        updateViberMsg(); // Ανανεώνει το μήνυμα Viber
                    })
                    .catch(error => console.error("Σφάλμα:", error));
            }
        }
    
        // 🔹 Υπολογισμός των τιμών με βάση την αρχική & τελική ένδειξη
        function updateValues() {
            let finalValue = parseFloat(finalIndication.value) || 0;
            let initialValue = parseFloat(initialIndication.value) || 0;
            let difference = finalValue - initialValue;
    
            cubicMeters.value = difference;
            billableCubicMeters.value = difference;
            hydronomistsCubicMeters.value = difference;
            cost.value = (difference * parseFloat(costPerMeter.value)).toFixed(2);
            hydronomistsRight.value = (difference * 0.05).toFixed(2);
    
            updateViberMsg();  // Ανανεώνει το μήνυμα Viber
        }
    
        // 🔹 Δυναμική ενημέρωση του `viberMsg`
        function updateViberMsg() {
            let customerValue = customer.options[customer.selectedIndex]?.text || "";
            // {% comment %} let dateValue = date.value || ""; {% endcomment %}
            // Μετατροπή ημερομηνίας: από "2025-06-27" σε "27-06-2025"
            let dateRaw = date.value || "";
            let dateValue = "";
            if (dateRaw) {
                const [yyyy, mm, dd] = dateRaw.split("-");
                dateValue = `${dd}-${mm}-${yyyy}`;
            }
            let finalValue = finalIndication.value || "";
            let initialValue = initialIndication.value || "";
            let costValue = cost.value || "";
            let billableCubicMetersValue = billableCubicMeters.value || "";
    
            let message = `${customerValue}, ${dateValue}, ${finalValue} - ${initialValue} = ${billableCubicMetersValue} κυβικά, ${costValue}€`;
            viberMsg.value = message;
        }
    
        // 🔹 Προσθήκη event listeners
        counterSelect.addEventListener("change", fetchFinalIndication);
        finalIndication.addEventListener("input", updateValues);
        initialIndication.addEventListener("input", updateValues);
        costPerMeter.addEventListener("input", updateValues);
        customer.addEventListener("change", updateViberMsg);
        date.addEventListener("input", updateViberMsg);
        cost.addEventListener("input", updateViberMsg);
    });

    document.addEventListener("DOMContentLoaded", function() {
        let copyButton = document.getElementById("copyMsgClb");
        let viberMsg = document.getElementById("id_viberMsg");

        copyButton.addEventListener("click", function() {
            if (viberMsg.value) {
                navigator.clipboard.writeText(viberMsg.value).then(() => {
//                    alert("Το μήνυμα αντιγράφηκε στο πρόχειρο!");
                }).catch(err => {
                    console.error("Σφάλμα αντιγραφής:", err);
                });
            } else {
                alert("Το πεδίο μηνύματος είναι κενό!");
            }
        });
    });
</script>
            
{% endblock %}
