{% extends "main.html" %}
{% load crispy_forms_tags %}
{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Αρχική</a></li>
    <li class="breadcrumb-item active" aria-current="page">Προσθήκη Ποτισμού</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <h2 style="font-size:1.3rem;">Προσθήκη Ποτίσματος</h2>
  <form method="post">
    {% csrf_token %}

    <div class="mb-3">
      {{ form.counter|as_crispy_field }}
    </div>

    <div class="row mb-3">
      <div class="col-12 col-md-4">{{ form.date|as_crispy_field }}</div>  
      <div class="col-12 col-md-4">{{ form.finalIndication|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.initialIndication|as_crispy_field }}</div>
    </div>    
      
    <div class="mb-3">
      {{ form.customer|as_crispy_field }}
    </div>

    <div class="row mb-3">
      <div class="col-12 col-md-4">{{ form.cubicMeters|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.billableCubicMeters|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.ydronomistFee|as_crispy_field }}</div>
    </div>

    <div class="row mb-3">
      <div class="col-12 col-md-4">{{ form.costPerMeter|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.cost|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.hydronomistsRight|as_crispy_field }}</div>
    </div>

    <div class="mb-3">
      {{ form.viberMsg|as_crispy_field }}
    </div>

    <div class="d-flex flex-column flex-md-row gap-2">
      <button type="submit" class="btn btn-success">Αποθήκευση</button>
      <button type="button" class="btn btn-info" id="copyMsgClb">Αντιγραφή Μηνύματος</button>
    </div>
  </form>
</div>
<style>
  @media (max-width: 576px) {
    h2 {
      font-size: 1.1rem !important;
    }
    .container-fluid, .row, .col-12 {
      padding-left: 5px !important;
      padding-right: 5px !important;
    }
    .btn {
      font-size: 0.95rem;
      padding: 0.4rem 0.7rem;
    }
    .mb-3 {
      margin-bottom: 0.7rem !important;
    }
  }
</style>


<script>
document.addEventListener("DOMContentLoaded", function() {
    let counterSelect = document.getElementById("id_counter");
    let initialIndication = document.getElementById("id_initialIndication");
    let finalIndication = document.getElementById("id_finalIndication");
    let cubicMeters = document.getElementById("id_cubicMeters");
    let billableCubicMeters = document.getElementById("id_billableCubicMeters");
    let cost = document.getElementById("id_cost");
    let hydronomistsRight = document.getElementById("id_hydronomistsRight");
    let costPerMeter = document.getElementById("id_costPerMeter");
    let ydronomistFee = document.getElementById("id_ydronomistFee");
    let customer = document.getElementById("id_customer");
    let date = document.getElementById("id_date");
    let viberMsg = document.getElementById("id_viberMsg");

    function setInitialValues() {
        let customerId = customer.value;
        let counterId = counterSelect.value;
        if (customerId && counterId) {
            fetch(`/get-params-for-watercons/?customer_id=${customerId}&counter_id=${counterId}`)
                .then(response => response.json())
                .then(data => {
                    ydronomistFee.value = data.ydronomistFee;
                    costPerMeter.value = data.costPerMeter;
                    updateCubicMetersAndBillable();
                    updateValues();
                });
        }
    }

    function fetchFinalIndication() {
        let counterId = counterSelect.value;
        if (counterId) {
            fetch(`/get-final-indication/${counterId}/`)
                .then(response => response.json())
                .then(data => {
                    initialIndication.value = data.finalIndication !== null ? data.finalIndication : "";
                    updateCubicMetersAndBillable();
                    updateValues();
                    updateViberMsg();
                })
                .catch(error => console.error("Σφάλμα:", error));
        }
    }

    // Αρχικοποίηση cubicMeters και billableCubicMeters
    function updateCubicMetersAndBillable() {
        let finalValue = parseFloat(finalIndication.value) || 0;
        let initialValue = parseFloat(initialIndication.value) || 0;
        let difference = finalValue - initialValue;
        cubicMeters.value = difference >= 0 ? difference : "";
        billableCubicMeters.value = cubicMeters.value; // ΜΟΝΟ αρχικά!
    }

    // Υπολογισμοί με βάση το billableCubicMeters
    function updateValues() {
        let billableValue = parseFloat(billableCubicMeters.value) || 0;
        let costPerMeterValue = parseFloat(costPerMeter.value) || 0;
        cost.value = (billableValue * costPerMeterValue).toFixed(2);

        let ydronomistFeeValue = parseFloat(ydronomistFee.value) || 0;
        hydronomistsRight.value = (billableValue * ydronomistFeeValue).toFixed(2);

        updateViberMsg();
    }

    function updateViberMsg() {
        let customerValue = customer.options[customer.selectedIndex]?.text || "";
        let dateRaw = date.value || "";
        let dateValue = "";
        if (dateRaw) {
            const [yyyy, mm, dd] = dateRaw.split("-");
            dateValue = `${dd}-${mm}-${yyyy}`;
        }
        let finalValue = finalIndication.value || "";
        let initialValue = initialIndication.value || "";
        let costValue = cost.value || "";
        let billableCubicMetersValue = billableCubicMeters.value || "";

        let message = `${customerValue}, ${dateValue}, ${finalValue} - ${initialValue} = ${billableCubicMetersValue} κυβικά, ${costValue}€`;
        viberMsg.value = message;
    }

    // Αρχικές τιμές όταν αλλάζει πελάτης ή μετρητής
    customer.addEventListener("change", setInitialValues);
    counterSelect.addEventListener("change", function() {
        setInitialValues();
        fetchFinalIndication();
    });

    finalIndication.addEventListener("input", function() {
        updateCubicMetersAndBillable();
        updateValues();
    });
    initialIndication.addEventListener("input", function() {
        updateCubicMetersAndBillable();
        updateValues();
    });

    costPerMeter.addEventListener("input", updateValues);
    ydronomistFee.addEventListener("input", updateValues);
    billableCubicMeters.addEventListener("input", updateValues); // Ο χρήστης μπορεί να το αλλάξει
    cubicMeters.addEventListener("input", updateValues);
    date.addEventListener("input", updateViberMsg);

    // Αντιγραφή μηνύματος
    let copyButton = document.getElementById("copyMsgClb");
    copyButton.addEventListener("click", function() {
        if (viberMsg.value) {
            navigator.clipboard.writeText(viberMsg.value);
        } else {
            alert("Το πεδίο μηνύματος είναι κενό!");
        }
    });

    // Αρχικοποίηση στην φόρτωση
    setInitialValues();
});
</script>
            
{% endblock %}
