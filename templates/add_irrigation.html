{% extends "main.html" %}
{% load crispy_forms_tags %}
{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Αρχική</a></li>
    <li class="breadcrumb-item active" aria-current="page">Προσθήκη Ποτισμού</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <h2 style="font-size:1.3rem;">Προσθήκη Ποτίσματος</h2>
  <form method="post">
    {% csrf_token %}

    <div class="mb-3">
      {{ form.counter|as_crispy_field }}
    </div>

    <div class="row mb-3">
      <div class="col-12 col-md-4">{{ form.date|as_crispy_field }}</div>  
      <div class="col-12 col-md-4">{{ form.finalIndication|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.initialIndication|as_crispy_field }}</div>
    </div>    
      
    <div class="mb-3">
      {{ form.customer|as_crispy_field }}
    </div>

    <div class="row mb-3">
      <div class="col-12 col-md-4">{{ form.cubicMeters|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.billableCubicMeters|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.hydronomistsCubicMeters|as_crispy_field }}</div>
    </div>

    <div class="row mb-3">
      <div class="col-12 col-md-4">{{ form.costPerMeter|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.cost|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.hydronomistsRight|as_crispy_field }}</div>
    </div>

    <div class="mb-3">
      {{ form.viberMsg|as_crispy_field }}
    </div>

    <div class="d-flex flex-column flex-md-row gap-2">
      <button type="submit" class="btn btn-success">Αποθήκευση</button>
      <button type="button" class="btn btn-info" id="copyMsgClb">Αντιγραφή Μηνύματος</button>
    </div>
  </form>
</div>
<style>
  @media (max-width: 576px) {
    h2 {
      font-size: 1.1rem !important;
    }
    .container-fluid, .row, .col-12 {
      padding-left: 5px !important;
      padding-right: 5px !important;
    }
    .btn {
      font-size: 0.95rem;
      padding: 0.4rem 0.7rem;
    }
    .mb-3 {
      margin-bottom: 0.7rem !important;
    }
  }
</style>


<script>
    document.addEventListener("DOMContentLoaded", function() {
        let counterSelect = document.getElementById("id_counter");
        let initialIndication = document.getElementById("id_initialIndication");
        let finalIndication = document.getElementById("id_finalIndication");
        let cubicMeters = document.getElementById("id_cubicMeters");
        let billableCubicMeters = document.getElementById("id_billableCubicMeters");
        let hydronomistsCubicMeters = document.getElementById("id_hydronomistsCubicMeters");
        let cost = document.getElementById("id_cost");
        let hydronomistsRight = document.getElementById("id_hydronomistsRight");
        let costPerMeter = document.getElementById("id_costPerMeter");
        let customer = document.getElementById("id_customer");
        let date = document.getElementById("id_date");
        let viberMsg = document.getElementById("id_viberMsg");
    
        // 🔹 Ανάκτηση της τελευταίας τιμής `finalIndication` για τον επιλεγμένο μετρητή
        function fetchFinalIndication() {
            let counterId = counterSelect.value;
            if (counterId) {
                fetch(`/get-final-indication/${counterId}/`)
                    .then(response => response.json())
                    .then(data => {
                        initialIndication.value = data.finalIndication !== null ? data.finalIndication : "";
                        updateValues();  // Ενημέρωση υπολογισμένων τιμών
                        updateViberMsg(); // Ανανεώνει το μήνυμα Viber
                    })
                    .catch(error => console.error("Σφάλμα:", error));
            }
        }
    
        // 🔹 Υπολογισμός των τιμών με βάση την αρχική & τελική ένδειξη
        function updateValues() {
            let finalValue = parseFloat(finalIndication.value) || 0;
            let initialValue = parseFloat(initialIndication.value) || 0;
            let difference = finalValue - initialValue;
    
            cubicMeters.value = difference;
            billableCubicMeters.value = difference;
            hydronomistsCubicMeters.value = difference;
            cost.value = (difference * parseFloat(costPerMeter.value)).toFixed(2);
            hydronomistsRight.value = (difference * 0.05).toFixed(2);
    
            updateViberMsg();  // Ανανεώνει το μήνυμα Viber
        }
    
        // 🔹 Δυναμική ενημέρωση του `viberMsg`
        function updateViberMsg() {
            let customerValue = customer.options[customer.selectedIndex]?.text || "";
            // {% comment %} let dateValue = date.value || ""; {% endcomment %}
            // Μετατροπή ημερομηνίας: από "2025-06-27" σε "27-06-2025"
            let dateRaw = date.value || "";
            let dateValue = "";
            if (dateRaw) {
                const [yyyy, mm, dd] = dateRaw.split("-");
                dateValue = `${dd}-${mm}-${yyyy}`;
            }
            let finalValue = finalIndication.value || "";
            let initialValue = initialIndication.value || "";
            let costValue = cost.value || "";
            let billableCubicMetersValue = billableCubicMeters.value || "";
    
            let message = `${customerValue}, ${dateValue}, ${finalValue} - ${initialValue} = ${billableCubicMetersValue} κυβικά, ${costValue}€`;
            viberMsg.value = message;
        }
    
        // 🔹 Προσθήκη event listeners
        counterSelect.addEventListener("change", fetchFinalIndication);
        finalIndication.addEventListener("input", updateValues);
        initialIndication.addEventListener("input", updateValues);
        costPerMeter.addEventListener("input", updateValues);
        customer.addEventListener("change", updateViberMsg);
        date.addEventListener("input", updateViberMsg);
        cost.addEventListener("input", updateViberMsg);
    });

    document.addEventListener("DOMContentLoaded", function() {
        let copyButton = document.getElementById("copyMsgClb");
        let viberMsg = document.getElementById("id_viberMsg");

        copyButton.addEventListener("click", function() {
            if (viberMsg.value) {
                navigator.clipboard.writeText(viberMsg.value).then(() => {
//                    alert("Το μήνυμα αντιγράφηκε στο πρόχειρο!");
                }).catch(err => {
                    console.error("Σφάλμα αντιγραφής:", err);
                });
            } else {
                alert("Το πεδίο μηνύματος είναι κενό!");
            }
        });
    });
</script>
            
{% endblock %}
