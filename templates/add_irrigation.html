{% extends "main.html" %}
{% load crispy_forms_tags %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Αρχική</a></li>
    <li class="breadcrumb-item active" aria-current="page">Προσθήκη Ποτισμού</li>
  </ol>
</nav>
{% endblock %}

{% block content %}

<style>
  .btn-copied {
    background-color: #28a745 !important; /* πράσινο */
    color: white !important;
    transition: background-color 0.3s ease;
  }

  .copied {
  background-color: #198754 !important; /* Bootstrap green */
  color: #fff !important;
  transition: background-color 0.3s;
}
</style>

<div class="container-fluid mt-4">
<h2 style="font-size:1.3rem;">Προσθήκη Ποτίσματος</h2>
  <form method="post">
      {% csrf_token %}

    <!-- 1. counter -->
    <div class="mb-3">{{ form.counter|as_crispy_field }}</div>
        <script>
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("id_counter").setAttribute("tabindex", "1");
      });
    </script>

    <div class="row mb-3">
    <div class="row mb-3">
      <!-- 2. date -->
      <div class="col-12 col-md-4">{{ form.date|as_crispy_field }}</div>
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          document.getElementById("id_date").setAttribute("tabindex", "2");
        });
      </script>

      <!-- 3. finalIndication -->
      <div class="col-12 col-md-4">{{ form.finalIndication|as_crispy_field }}</div>
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          document.getElementById("id_finalIndication").setAttribute("tabindex", "3");
        });
      </script>

      <!-- initialIndication μένει εκτός -->
      <div class="col-12 col-md-4">{{ form.initialIndication|as_crispy_field }}</div>
    </div>

    <div class="row mb-3">
      <!-- 4. customer -->
      <div class="col-12 col-md-8">{{ form.customer|as_crispy_field }}</div>
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          document.getElementById("id_customer").setAttribute("tabindex", "4");
        });
      </script>

      <div class="col-12 col-md-4">
        <div class="form-group mb-0">
          <label for="id_customer_phone" class="form-label mb-0">Τηλέφωνο</label>
          <input type="text" id="id_customer_phone" class="form-control" placeholder="Τηλέφωνο" tabindex="-1">
        </div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-12 col-md-4">{{ form.cubicMeters|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.billableCubicMeters|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.ydronomistFee|as_crispy_field }}</div>
    </div>

    <div class="row mb-3">
      <div class="col-12 col-md-4">{{ form.costPerMeter|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.cost|as_crispy_field }}</div>
      <div class="col-12 col-md-4">{{ form.hydronomistsRight|as_crispy_field }}</div>
    </div>

    <div class="mb-3">
      {{ form.msg|as_crispy_field }}
    </div>

    <!-- Κουμπιά με σειρά -->
    <div class="d-flex flex-column flex-md-row gap-2">
      <button type="button" class="btn btn-info" id="copyPhoneClb" tabindex="5">Αντιγραφή Τηλεφώνου</button>
      <button type="button" class="btn btn-info" id="copyMsgClb" tabindex="6">Αντιγραφή Μηνύματος</button>
      <button type="button" class="btn btn-primary" id="sendSmsBtn" tabindex="7">Αποστολή SMS</button>
      <button type="submit" class="btn btn-success" tabindex="8">Αποθήκευση</button>
    </div>

    <!-- Container για SMS alerts -->
    <div id="smsAlertContainer" class="mt-2"></div>
  </form>
</div>

<style>
  @media (max-width: 576px) {
    h2 {
      font-size: 1.1rem !important;
    }
    .container-fluid, .row, .col-12 {
      padding-left: 5px !important;
      padding-right: 5px !important;
    }
    .btn {
      font-size: 0.95rem;
      padding: 0.4rem 0.7rem;
    }
    .mb-3 {
      margin-bottom: 0.7rem !important;
    }
  }
</style>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // --- Αρχικοποίηση πεδίων ---
    const customer = document.getElementById("id_customer");
    const counterSelect = document.getElementById("id_counter");
    const ydronomistFee = document.getElementById("id_ydronomistFee");
    const costPerMeter = document.getElementById("id_costPerMeter");
    const billableCubicMeters = document.getElementById("id_billableCubicMeters");
    const cubicMeters = document.getElementById("id_cubicMeters");
    const hydronomistsRight = document.getElementById("id_hydronomistsRight");
    const finalIndication = document.getElementById("id_finalIndication");
    const initialIndication = document.getElementById("id_initialIndication");
    const cost = document.getElementById("id_cost");
    const customerPhone = document.getElementById("id_customer_phone");
    const date = document.getElementById("id_date");
    const msg = document.getElementById("id_msg");

    // --- Ανάκτηση τηλεφώνου πελάτη ---
    function fetchCustomerPhone() {
        const customerId = customer.value;
        if (!customerId) {
            customerPhone.value = "";
            return;
        }
        fetch(`/ajax/get_person_phone/${customerId}/`)
            .then(response => response.json())
            .then(data => {
                customerPhone.value = data.phone || "";
            });
    }

    // --- Ανάκτηση αρχικής ένδειξης μετρητή ---
    function fetchInitialIndication() {
        const counterId = counterSelect.value;
        if (!counterId) return;
        fetch(`/ajax/get_counter_last_reading/${counterId}/`)
            .then(response => response.json())
            .then(data => {
                initialIndication.value = data.last_reading || "";
                updateCubicMeters();
                updateCalculatedFields();
            });
    }

    // --- Ανάκτηση παραμέτρων για ydronomistFee και costPerMeter ---
    function fetchParamsAndUpdate() {
        const customerId = customer.value;
        const counterId = counterSelect.value;
        if (!customerId || !counterId) return;

        fetch(`/ajax/get_watercons_params/?customer_id=${customerId}&counter_id=${counterId}`)
            .then(response => response.json())
            .then(data => {
                ydronomistFee.value = data.ydronomistFee;
                costPerMeter.value = data.costPerMeter;
                updateCalculatedFields();
            });
    }

    // --- Υπολογισμός κυβικών και χρεώσιμων κυβικών ---
    function updateCubicMeters() {
        const finalValue = parseFloat(finalIndication.value) || 0;
        const initialValue = parseFloat(initialIndication.value) || 0;
        const diff = finalValue - initialValue;
        cubicMeters.value = diff >= 0 ? diff : "";
        billableCubicMeters.value = cubicMeters.value;
    }

    // --- Υπολογισμοί κόστους και δικαιώματος υδρονομέα ---
    function updateCalculatedFields() {
        const billable = parseFloat(billableCubicMeters.value) || 0;
        const ydronomistFeeValue = parseFloat(ydronomistFee.value) || 0;
        const costPerMeterValue = parseFloat(costPerMeter.value) || 0;

        hydronomistsRight.value = (billable * ydronomistFeeValue).toFixed(2);
        cost.value = (billable * costPerMeterValue).toFixed(2);

        updateMsg();
    }

    // --- Σύνθεση μηνύματος ---
    function updateMsg() {
        const customerText = customer.options[customer.selectedIndex]?.text || "";
        const dateValue = date.value || "";
        const finalValue = finalIndication.value || "";
        const initialValue = initialIndication.value || "";
        const billable = billableCubicMeters.value || "";
        const costValue = cost.value || "";

        let message = `${customerText}, ${dateValue}, ${finalValue} - ${initialValue} = ${billable} κυβικά, ${costValue}€`;
        msg.value = message;
    }

    // --- Αντιγραφή με γραφικό feedback ---
    function copyWithFeedback(inputId, btnId, successText) {
        const input = document.getElementById(inputId);
        const btn = document.getElementById(btnId);
        if (input && btn) {
            navigator.clipboard.writeText(input.value).then(() => {
                const oldText = btn.textContent;
                btn.classList.add('copied');
                btn.textContent = successText;
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.textContent = oldText;
                }, 1200);
            });
        }
    }

    // --- Event listeners ---
    customer.addEventListener("change", function() {
        fetchCustomerPhone();
        fetchParamsAndUpdate();
    });
    counterSelect.addEventListener("change", function() {
        fetchInitialIndication();
        fetchParamsAndUpdate();
    });

    finalIndication.addEventListener("input", function() {
        updateCubicMeters();
        updateCalculatedFields();
    });
    initialIndication.addEventListener("input", function() {
        updateCubicMeters();
        updateCalculatedFields();
    });

    billableCubicMeters.addEventListener("input", updateCalculatedFields);
    ydronomistFee.addEventListener("input", updateCalculatedFields);
    costPerMeter.addEventListener("input", updateCalculatedFields);
    date.addEventListener("input", updateMsg);

    document.getElementById("copyPhoneClb").addEventListener("click", function() {
        copyWithFeedback("id_customer_phone", "copyPhoneClb", "Το τηλέφωνο αντιγράφηκε!");
    });
    document.getElementById("copyMsgClb").addEventListener("click", function() {
        copyWithFeedback("id_msg", "copyMsgClb", "Το μήνυμα αντιγράφηκε!");
    });

    // --- Αρχικοποίηση στην φόρτωση ---
    fetchCustomerPhone();
    fetchInitialIndication();
    fetchParamsAndUpdate();
});
</script>
{% endblock %}
